# GitHub Actions 工作流 - Claude AI 自动填写 PR 模板
# 功能：在PR创建时自动触发Claude AI分析变更并填写PR模板
# 触发条件：仅在PR首次创建时触发，避免覆盖用户手动修改

name: Claude AI 填写 PR 模板

on:
  pull_request:
    types: [opened]
    branches:
      - main
      - develop

# 设置并发控制
concurrency:
  group: pr-template-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  fill-pr-template:
    name: 填写 PR 模板
    runs-on: ubuntu-latest

    # 仅在PR描述为空或包含模板占位符时运行
    if: |
      github.event.pull_request.body == '' ||
      contains(github.event.pull_request.body, '<!-- 请简要描述')

    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 获取变更信息
        id: changes
        run: |
          # 获取变更的文件列表
          git fetch origin ${{ github.base_ref }}

          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | head -50)
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # 获取变更统计
          STATS=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1)
          echo "stats=$STATS" >> $GITHUB_OUTPUT

          # 获取提交信息
          COMMITS=$(git log --oneline origin/${{ github.base_ref }}..HEAD | head -10)
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Claude AI 填写模板
        uses: anthropics/claude-code-action@beta
        with:
          claude_access_token: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          direct_prompt: |
            你是一位专业的技术文档撰写专家。请根据以下PR变更信息，填写PR模板。

            **项目信息**：
            - 项目名称：Zotero-Notion-Paper-Flow
            - 项目描述：从HuggingFace和arXiv抓取学术论文，使用LLM分析并同步到Notion/Zotero

            **PR信息**：
            - 标题：${{ github.event.pull_request.title }}
            - 分支：${{ github.head_ref }} -> ${{ github.base_ref }}
            - 提交者：${{ github.event.pull_request.user.login }}

            **变更的文件**：
            ${{ steps.changes.outputs.changed_files }}

            **变更统计**：
            ${{ steps.changes.outputs.stats }}

            **提交记录**：
            ${{ steps.changes.outputs.commits }}

            **请按以下模板格式填写，用中文输出**：

            ## 变更描述

            [根据变更的文件和提交记录，简要描述本次PR的主要变更内容，2-3句话]

            ## 变更类型

            [根据变更内容，在对应类型前标记 x，如 - [x] 新功能]
            - [ ] 新功能 (feature)
            - [ ] Bug修复 (bugfix)
            - [ ] 代码重构 (refactor)
            - [ ] 文档更新 (docs)
            - [ ] 测试相关 (test)
            - [ ] 配置/构建相关 (chore)

            ## 相关Issue

            [如果从提交信息或分支名称能推断出相关Issue，请填写，否则写"无"]

            ## 变更内容

            ### 新增
            [列出新增的功能/文件]

            ### 修改
            [列出修改的功能/文件]

            ### 删除
            [列出删除的功能/文件，如无则写"无"]

            ## 测试说明

            [根据变更类型，建议合适的测试方法]

            - [ ] 已在本地测试通过
            - [ ] 已添加/更新相关测试用例
            - [ ] 已验证与现有功能的兼容性

            ## 检查清单

            - [ ] 代码遵循项目的编码规范
            - [ ] 已添加必要的注释和文档
            - [ ] 所有新增的依赖已添加到 requirements.txt
            - [ ] 没有引入敏感信息（API密钥、密码等）
            - [ ] 已考虑安全性影响

            ## 其他说明

            [如有需要特别说明的内容，请在此补充，否则写"无"]

            ---

            *此模板由 Claude AI 自动填写，请审核并根据实际情况修改*

          timeout_minutes: 5
          model: claude-sonnet-4-20250514

      - name: 模板填写完成
        if: always()
        run: |
          echo "PR模板填写状态: ${{ job.status }}"
          echo "PR #${{ github.event.pull_request.number }} 模板已处理"
