# GitHub Actions 工作流 - Claude AI 自动代码审查
# 功能：在PR创建或更新时自动触发Claude AI进行代码审查
# 审查内容：代码质量、安全性、最佳实践、Python规范等

name: Claude AI 代码审查

on:
  pull_request:
    types: [opened, synchronize, reopened]
    # 监听所有分支的PR
    branches:
      - main
      - develop
      - 'feature/**'
      - 'release/**'

# 设置并发控制，避免同一PR的多次审查同时运行
concurrency:
  group: code-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  claude-code-review:
    name: Claude AI 代码审查
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # 获取完整历史以便比较差异

      - name: 获取PR变更文件
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          separator: "\n"

      - name: 获取PR差异内容
        id: pr-diff
        run: |
          # 获取PR的差异内容
          git fetch origin ${{ github.base_ref }}
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD -- '*.py' '*.yml' '*.yaml' '*.json' '*.md' '*.toml' '*.txt' | head -c 50000)

          # 将差异内容保存到文件
          echo "$DIFF" > /tmp/pr_diff.txt

          # 获取变更的Python文件列表
          CHANGED_PY_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- '*.py' | tr '\n' ' ')
          echo "changed_py_files=$CHANGED_PY_FILES" >> $GITHUB_OUTPUT

          echo "差异内容已保存，变更的Python文件: $CHANGED_PY_FILES"

      - name: Claude AI 代码审查
        id: claude-review
        uses: anthropics/claude-code-action@beta
        with:
          # Claude Max 订阅用户使用 claude_access_token 而非 anthropic_api_key
          # 获取方式：登录 https://claude.ai -> 打开开发者工具 -> Application -> Cookies -> sessionKey
          # 将 sessionKey 的值保存到 GitHub Secrets 中，命名为 CLAUDE_ACCESS_TOKEN
          claude_access_token: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          direct_prompt: |
            你是一位资深的Python代码审查专家。请对以下Pull Request进行全面的代码审查。

            **项目背景**：
            这是一个Python项目（Zotero-Notion-Paper-Flow），用于：
            - 从HuggingFace和arXiv抓取学术论文
            - 使用LLM（大语言模型）分析论文内容
            - 将论文信息同步到Notion数据库和Zotero文献管理工具

            **审查要求**：
            请用中文输出所有审查内容，并按以下方面进行详细审查：

            ## 1. 代码质量
            - 代码结构是否清晰、模块化
            - 命名是否规范（变量、函数、类）
            - 是否有重复代码可以重构
            - 函数/方法是否过长，是否需要拆分
            - 注释是否充分且有意义

            ## 2. Python最佳实践
            - 是否遵循PEP 8编码规范
            - 类型注解是否完整
            - 异常处理是否恰当
            - 是否正确使用Python特性（生成器、上下文管理器等）
            - import语句是否规范

            ## 3. 安全性检查
            - 是否存在硬编码的密钥或敏感信息
            - API调用是否安全（认证、授权）
            - 用户输入是否有验证和清理
            - 是否有SQL注入、XSS等安全风险
            - 依赖库是否有已知漏洞

            ## 4. 性能考量
            - 是否有明显的性能问题
            - 数据库/API调用是否优化
            - 是否有不必要的循环或重复计算
            - 内存使用是否合理

            ## 5. 可维护性
            - 代码是否易于理解和修改
            - 是否有适当的错误处理和日志记录
            - 配置是否外部化
            - 是否便于测试

            ## 6. 项目特定检查
            - HuggingFace/arXiv API调用是否正确
            - Notion/Zotero集成是否合理
            - LLM调用是否高效且有错误处理
            - 数据同步逻辑是否健壮

            **输出格式要求**：

            ### 总体评价
            [对本次PR的整体评价，1-2句话概括]

            ### 优点
            - [列出代码中做得好的地方]

            ### 需要修改的问题
            | 严重程度 | 文件 | 行号 | 问题描述 | 修改建议 |
            |---------|------|------|---------|---------|
            | 高/中/低 | 文件名 | 行号 | 问题 | 建议 |

            ### 建议改进项
            - [可选的改进建议，非强制]

            ### 安全提醒
            - [如有安全相关问题，特别标注]

            请确保审查内容专业、具体、可操作，帮助开发者改进代码质量。
          timeout_minutes: 10
          model: claude-sonnet-4-20250514

      - name: 审查完成通知
        if: always()
        run: |
          echo "Claude AI 代码审查已完成"
          echo "审查状态: ${{ steps.claude-review.outcome }}"

  # Python代码静态检查（作为补充）
  python-lint:
    name: Python 代码检查
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v6

      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 安装检查工具
        run: |
          python -m pip install --upgrade pip
          pip install ruff bandit

      - name: Ruff 代码风格检查
        id: ruff
        continue-on-error: true
        run: |
          echo "## Ruff 代码风格检查结果" >> $GITHUB_STEP_SUMMARY
          ruff check . --output-format=github || true
          ruff check . --output-format=text >> $GITHUB_STEP_SUMMARY 2>&1 || true

      - name: Bandit 安全检查
        id: bandit
        continue-on-error: true
        run: |
          echo "## Bandit 安全检查结果" >> $GITHUB_STEP_SUMMARY
          bandit -r . -f txt --skip B101 >> $GITHUB_STEP_SUMMARY 2>&1 || true

      - name: 发布检查报告评论
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');

            // 读取步骤摘要
            let summary = '';
            try {
              summary = fs.readFileSync(process.env.GITHUB_STEP_SUMMARY, 'utf8');
            } catch (e) {
              summary = '代码检查已完成，请查看Actions日志获取详细信息。';
            }

            const body = `## Python 静态代码检查报告

            ${summary || '检查已完成，未发现重大问题。'}

            ---
            *此报告由 GitHub Actions 自动生成*`;

            // 查找是否已有评论
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Python 静态代码检查报告')
            );

            if (botComment) {
              // 更新已有评论
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // 创建新评论
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
